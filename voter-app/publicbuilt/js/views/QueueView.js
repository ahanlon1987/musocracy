define(["jquery","underscore","backbone","templates","models/QueueModel","views/ListItemView","collections/VotesCollection","collections/SpotifySearchCollection","models/LocationModel","util/persist","util/dispatcher"],function(e,t,n,r,i,s,o,u,a,f,l){var c=108e5,h;return n.View.extend({events:{"keyup .search input":"onKeyPress","click .location-queue .track:not(.disabled)":"onTrackClick","click .spotify-results .track:not(.disabled)":"onSearchResultClick","click .clear-search":"onClearSearch"},initialize:function(){this.locationId=this.options.locationId,this.locationModel=this.options.locationModel,l.on(l.events.REFRESH,this.onRefresh,this)},render:function(){return this.$el.html(r.queue.render()),this.searchCollection=new u,this.locationModel.fetch({success:e.proxy(this.onLocationFetched,this)}),this},renderQueue:function(n){var i="";t.each(n,function(n){var s=e.inArray(n.get("trackId"),t.pluck(amplify.store("previousVotes"),"trackId"));if(s>=0){var o=amplify.store("previousVotes")[s];o&&new Date-new Date(o.voteTime)<c&&n.set("disabled","disabled")}i+=r.track.render(n.attributes)}),this.$(".location-queue").html(i)},onRefresh:function(){this.locationModel.fetch({success:e.proxy(this.onLocationFetched,this)})},onLocationFetched:function(){var e=this.locationModel.getVotes(),t=this.$(".search input").val();t?this.filterVotesCollection(t):this.renderQueue(e.models)},onKeyPress:function(t){window.clearTimeout(h);var n=this.$(".search input").val();t&&t.which===13?this.search():t&&t.which===8&&n==""?(console.log("backspace pressed with no no content in search field, clearing search results"),this.onClearSearch()):h=setTimeout(e.proxy(this.search,this),500),this.filterVotesCollection(n)},onTrackClick:function(e){e&&e.preventDefault();var t=this.$(e.currentTarget),n=t.data("trackid"),r=this.locationModel.getVotes(),i=r.getTrackById(n);i&&this.addVote(i)},onSearchResultClick:function(e){e&&e.preventDefault();var t=this.$(e.currentTarget);t.remove();var n=t.data("trackid"),r=this.searchCollection.getTrackById(n);if(r){var i=this.locationModel.getVotes();i.add(r),this.addVote(r)}},addVote:function(e){var t=this,n=e.get("votes");n?n++:n=1,e.set("votes",n),e.set("disabled","disabled"),this.onLocationFetched(),this.highlightTrack(e),this.disableTrack(e),f.vote(e,{success:function(e){t.locationModel=new a(e,{locationId:t.locationId})}})},highlightTrack:function(e){var t=e.get("domId"),n=this.$("#"+t),r=n.css("background-color");n.animate({"background-color":"#C7F5C1"},250),setTimeout(function(){n.animate({"background-color":r},750)},500)},disableTrack:function(e){var t=e.get("domId"),n=this.$("#"+t);n.addClass("disabled")},onClearSearch:function(e){this.$(".search input").val(""),this.$(".spotify-results").empty(),this.renderQueue(this.locationModel.getVotes().models)},search:function(){var e=this.$(".search input").val();console.log("Executing search on: "+e);var t=this.$(".spotify-results");if(e){t.html("Loading...."),this.searchCollection.url="/location/"+this.locationId+"/search/track?q="+e;var n=this;this.searchCollection.fetch().done(function(){var e="";n.searchCollection.isEmpty()?e="No Results Found, please try again.":n.searchCollection.each(function(t){e+=r.track.render(t.attributes)}),t.html(e)}).fail(function(){console.log("Handling failed spotify search, redrawing..."),t.html("Search failed, please try again.")})}else t.empty()},filterVotesCollection:function(e){var t=this.locationModel.getVotes(),n=t.getFilteredResults(e);this.renderQueue(n)}})});