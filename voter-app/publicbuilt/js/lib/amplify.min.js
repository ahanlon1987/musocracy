/*!
 * AmplifyJS 1.1.0 - Core, Store, Request
 * 
 * Copyright 2011 appendTo LLC. (http://appendto.com/team)
 * Dual licensed under the MIT or GPL licenses.
 * http://appendto.com/open-source-licenses
 * 
 * http://amplifyjs.com
 */

(function(e,t){var n=[].slice,r={},i=e.amplify={publish:function(e){var t=n.call(arguments,1),i,s,o,u=0,a;if(!r[e])return!0;i=r[e].slice();for(o=i.length;u<o;u++){s=i[u],a=s.callback.apply(s.context,t);if(a===!1)break}return a!==!1},subscribe:function(e,t,n,i){arguments.length===3&&typeof n=="number"&&(i=n,n=t,t=null),arguments.length===2&&(n=t,t=null),i=i||10;var s=0,o=e.split(/\s/),u=o.length,a;for(;s<u;s++){e=o[s],a=!1,r[e]||(r[e]=[]);var f=r[e].length-1,l={callback:n,context:t,priority:i};for(;f>=0;f--)if(r[e][f].priority<=i){r[e].splice(f+1,0,l),a=!0;break}a||r[e].unshift(l)}return n},unsubscribe:function(e,t){if(!!r[e]){var n=r[e].length,i=0;for(;i<n;i++)if(r[e][i].callback===t){r[e].splice(i,1);break}}}}})(this),function(e,t){function n(e,n){r.addType(e,function(s,o,u){var f,l,h,p,v=o,m=(new Date).getTime();if(!s){v={},p=[],h=0;try{s=n.length;while(s=n.key(h++))i.test(s)&&(l=JSON.parse(n.getItem(s)),l.expires&&l.expires<=m?p.push(s):v[s.replace(i,"")]=l.data);while(s=p.pop())n.removeItem(s)}catch(g){}return v}s="__amplify__"+s;if(o===t){f=n.getItem(s),l=f?JSON.parse(f):{expires:-1};if(!(l.expires&&l.expires<=m))return l.data;n.removeItem(s)}else if(o===null)n.removeItem(s);else{l=JSON.stringify({data:o,expires:u.expires?m+u.expires:null});try{n.setItem(s,l)}catch(g){r[e]();try{n.setItem(s,l)}catch(g){throw r.error()}}}return v})}var r=e.store=function(e,t,n,i){var i=r.type;return n&&n.type&&n.type in r.types&&(i=n.type),r.types[i](e,t,n||{})};r.types={},r.type=null,r.addType=function(e,t){r.type||(r.type=e),r.types[e]=t,r[e]=function(t,n,i){return i=i||{},i.type=e,r(t,n,i)}},r.error=function(){return"amplify.store quota exceeded"};var i=/^__amplify__/;for(var s in{localStorage:1,sessionStorage:1})try{window[s].getItem&&n(s,window[s])}catch(o){}if(window.globalStorage)try{n("globalStorage",window.globalStorage[window.location.hostname]),r.type==="sessionStorage"&&(r.type="globalStorage")}catch(o){}(function(){if(!r.types.localStorage){var e=document.createElement("div"),n="amplify";e.style.display="none",document.getElementsByTagName("head")[0].appendChild(e);try{e.addBehavior("#default#userdata"),e.load(n)}catch(i){e.parentNode.removeChild(e);return}r.addType("userData",function(i,s,o){e.load(n);var u,f,l,h,p,v=s,m=(new Date).getTime();if(!i){v={},p=[],h=0;while(u=e.XMLDocument.documentElement.attributes[h++])f=JSON.parse(u.value),f.expires&&f.expires<=m?p.push(u.name):v[u.name]=f.data;while(i=p.pop())e.removeAttribute(i);return e.save(n),v}i=i.replace(/[^-._0-9A-Za-z\xb7\xc0-\xd6\xd8-\xf6\xf8-\u037d\u37f-\u1fff\u200c-\u200d\u203f\u2040\u2070-\u218f]/g,"-");if(s===t){u=e.getAttribute(i),f=u?JSON.parse(u):{expires:-1};if(!(f.expires&&f.expires<=m))return f.data;e.removeAttribute(i)}else s===null?e.removeAttribute(i):(l=e.getAttribute(i),f=JSON.stringify({data:s,expires:o.expires?m+o.expires:null}),e.setAttribute(i,f));try{e.save(n)}catch(g){l===null?e.removeAttribute(i):e.setAttribute(i,l),r.userData();try{e.setAttribute(i,f),e.save(n)}catch(g){throw l===null?e.removeAttribute(i):e.setAttribute(i,l),r.error()}}return v})}})(),function(){function e(e){return e===t?t:JSON.parse(JSON.stringify(e))}var n={},i={};r.addType("memory",function(r,s,o){return r?s===t?e(n[r]):(i[r]&&(clearTimeout(i[r]),delete i[r]),s===null?(delete n[r],null):(n[r]=s,o.expires&&(i[r]=setTimeout(function(){delete n[r],delete i[r]},o.expires)),s)):e(n)})}()}(this.amplify=this.amplify||{}),function(e,t){function n(e){var t=!1;return setTimeout(function(){t=!0},1),function(){var n=this,r=arguments;t?e.apply(n,r):setTimeout(function(){e.apply(n,r)},1)}}function r(e){return{}.toString.call(e)==="[object Function]"}function i(){}e.request=function(t,s,o){var u=t||{};typeof u=="string"&&(r(s)&&(o=s,s={}),u={resourceId:t,data:s||{},success:o});var f={abort:i},l=e.request.resources[u.resourceId],h=u.success||i,p=u.error||i;u.success=n(function(t,n){n=n||"success",e.publish("request.success",u,t,n),e.publish("request.complete",u,t,n),h(t,n)}),u.error=n(function(t,n){n=n||"error",e.publish("request.error",u,t,n),e.publish("request.complete",u,t,n),p(t,n)});if(!l)throw u.resourceId?"amplify.request: unknown resourceId: "+u.resourceId:"amplify.request: no resourceId provided";if(!!e.publish("request.before",u))return e.request.resources[u.resourceId](u,f),f;u.error(null,"abort")},e.request.types={},e.request.resources={},e.request.define=function(t,n,r){if(typeof n=="string"){if(!(n in e.request.types))throw"amplify.request.define: unknown type: "+n;r.resourceId=t,e.request.resources[t]=e.request.types[n](r)}else e.request.resources[t]=n}}(amplify),function(e,t,n){var r=["status","statusText","responseText","responseXML","readyState"],i=/\{([^\}]+)\}/g;e.request.types.ajax=function(i){return i=t.extend({type:"GET"},i),function(s,o){function u(e,i){t.each(r,function(e,t){try{m[t]=f[t]}catch(n){}}),/OK$/.test(m.statusText)&&(m.statusText="success"),e===n&&(e=null),v&&(i="abort"),/timeout|error|abort/.test(i)?m.error(e,i):m.success(e,i),u=t.noop}var f,l=i.url,h=o.abort,p=t.extend(!0,{},i,{data:s.data}),v=!1,m={readyState:0,setRequestHeader:function(e,t){return f.setRequestHeader(e,t)},getAllResponseHeaders:function(){return f.getAllResponseHeaders()},getResponseHeader:function(e){return f.getResponseHeader(e)},overrideMimeType:function(e){return f.overrideMideType(e)},abort:function(){v=!0;try{f.abort()}catch(e){}u(null,"abort")},success:function(e,t){s.success(e,t)},error:function(e,t){s.error(e,t)}};e.publish("request.ajax.preprocess",i,s,p,m),t.extend(p,{success:function(e,t){u(e,t)},error:function(e,t){u(null,t)},beforeSend:function(t,n){f=t,p=n;var r=i.beforeSend?i.beforeSend.call(this,m,p):!0;return r&&e.publish("request.before.ajax",i,s,p,m)}}),t.ajax(p),o.abort=function(){m.abort(),h.call(this)}}},e.subscribe("request.ajax.preprocess",function(e,n,r){var s=[],o=r.data;typeof o!="string"&&(o=t.extend(!0,{},e.data,o),r.url=r.url.replace(i,function(e,t){if(t in o)return s.push(t),o[t]}),t.each(s,function(e,t){delete o[t]}),r.data=o)}),e.subscribe("request.ajax.preprocess",function(e,n,r){var i=r.data,s=e.dataMap;!!s&&typeof i!="string"&&(t.isFunction(s)?r.data=s(i):(t.each(e.dataMap,function(e,t){e in i&&(i[t]=i[e],delete i[e])}),r.data=i))});var s=e.request.cache={_key:function(e,t,n){function r(){return n.charCodeAt(s++)<<24|n.charCodeAt(s++)<<16|n.charCodeAt(s++)<<8|n.charCodeAt(s++)<<0}n=t+n;var i=n.length,s=0,o=r();while(s<i)o^=r();return"request-"+e+"-"+o},_default:function(){var e={};return function(t,n,r,i){var o=s._key(n.resourceId,r.url,r.data),u=t.cache;if(o in e)return i.success(e[o]),!1;var l=i.success;i.success=function(t){e[o]=t,typeof u=="number"&&setTimeout(function(){delete e[o]},u),l.apply(this,arguments)}}}()};e.store&&(t.each(e.store.types,function(t){s[t]=function(n,r,i,o){var u=s._key(r.resourceId,i.url,i.data),l=e.store[t](u);if(l)return i.success(l),!1;var c=o.success;o.success=function(r){e.store[t](u,r,{expires:n.cache.expires}),c.apply(this,arguments)}}}),s.persist=s[e.store.type]),e.subscribe("request.before.ajax",function(e){var t=e.cache;if(t)return t=t.type||t,s[t in s?t:"_default"].apply(this,arguments)}),e.request.decoders={jsend:function(e,t,n,r,i){e.status==="success"?r(e.data):e.status==="fail"?i(e.data,"fail"):e.status==="error"&&(delete e.status,i(e,"error"))}},e.subscribe("request.before.ajax",function(n,r,i,s){function o(e,t){l(e,t)}function u(e,t){f(e,t)}var f=s.success,l=s.error,c=t.isFunction(n.decoder)?n.decoder:n.decoder in e.request.decoders?e.request.decoders[n.decoder]:e.request.decoders._default;!c||(s.success=function(e,t){c(e,t,s,u,o)},s.error=function(e,t){c(e,t,s,u,o)})})}(amplify,jQuery);